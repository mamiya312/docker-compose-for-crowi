version: '3.5'
services:
  app:
    image: bakudankun/crowi:latest
    environment:
      MONGO_URI: mongodb://db:27017/crowi
      REDIS_URL: redis://redis:6379/crowi
      PASSWORD_SEED: ${PASSWORD_SEED}
    ports:
    - ${LISTEN_HOST}:${LISTEN_PORT}:3000/tcp
    restart: always
    volumes:
    - app-uploads-volume:/usr/src/app/public/uploads:rw
    depends_on:
    - db
    - es
  db:
    image: mongo:latest
    volumes:
    - db-volume:/data/db:rw
    restart: always
  es:
    image: elasticsearch:6.8.1
    entrypoint:
    - bash
    - -c
    - elasticsearch-plugin list | grep -q analysis-kuromoji || elasticsearch-plugin
      install analysis-kuromoji && exec $$0 $$@
    environment:
      ES_JAVA_OPTS: -DproxyHost=${PROXY_HOST} -DproxyPort=${PROXY_PORT}
      xpack.security.enabled: "false"
    command:
    - /usr/local/bin/docker-entrypoint.sh
    restart: always
  redis:
    image: redis:alpine
    restart: always
volumes:
  app-uploads-volume: {}
  db-volume: {}
